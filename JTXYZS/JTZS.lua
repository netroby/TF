JTZS={
	JTTabType=5,   
	JTIndex=5284,
	tFlyChNew={
		["TYZZ2Hero"]="传送到英雄太原之战・逐虎驱狼（限制等级90）",		
		["TYZZ1Hero"]="传送到英雄太原之战・夜守孤城（限制等级90）",			
		["TaiYu0"]="传送到太原",																--太原
		["TYZZ2"]="传送到太原之战・逐虎驱狼（限制等级90）",			--太原之战・逐虎驱狼
		["YMG"]="传送到雁门关之役（限制等级90）",			
		["TYZZ1"]="传送到太原之战・夜守孤城（限制等级90）",			--太原之战・夜守孤城 原来的TaiYuan
		["CMM"]="传送到春明门（限制等级90）",					
		["MJMD"]="传送到墨家秘殿（限制等级90）",				
		["QHL"]="传送到10人秦皇陵（限制等级90）",					
		["FXDXC"]="传送到10人风雪稻香村（限制等级90）",					
		["ZCM"]="传送到直城门（限制等级90）",					
		["XZTC10"]="传送到10人血战天策（限制等级90）",						
		["XZTC25"]="传送到25人血战天策（限制等级90）",	 
		["LuoYZL"]="传送到洛阳・战乱（推荐等级80）",	
		["MWY"]="传送到马嵬驿（推荐等级80）",				 
		["ChAn"]="传送到长安・战乱（推荐等级85）",				--是战乱		 
		["DXC"]="传送到稻香村(若地图人数已满请多试几次)",					
		["LuoY"]="传送到洛阳",	
		["YaZh"]="传送到扬州",	
		["ChDu"]="传送到成都",					
		["CY"]="传送到纯阳",				
		["WH"]="传送到万花",		
		["TC"]="传送到天策",	 
		["SL"]="传送到少林",
		["QX"]="传送到七秀",			 
		["CJ"]="传送到藏剑",			 	 
		["WD"]="传送到五毒",		
		["GB"]="传送到丐帮",				
		["MJ"]="传送到明教",				
		["TM"]="传送到唐门",				
		["CC"]="传送到苍云",				
		["CCXS"]="传送到苍云血誓",		--苍云血誓 是什么鬼？			
	},
	tRoleType={"成男","女子","3号体型","4号体型","小男孩","小女孩",},
	tMPCh={
		["TC"]="加入天策并获得技能",
		["CY"]="加入纯阳并获得技能",
		["WH"]="加入万花并获得技能",
		["XX"]="加入七秀并获得技能",
		["SL"]="加入少林并获得技能",
		["CJ"]="加入藏剑并获得技能",
		["WD"]="加入五毒并获得技能",
		["TM"]="加入唐门并获得技能",
		["MJ"]="加入明教并获得技能",
		["GB"]="加入丐帮并获得技能",
		["CC"]="加入苍云并获得技能",
	},
	tPVECh = {
		["310"]="获取310品PVE装备",
		["435"]="获取435品PVE装备",
		["485"]="获取485品PVE装备",
		["515"]="获取515品PVE装备（临时表现）",		--临时表现 又是什么鬼
		["435a"]="获取435品PVE装备",	
	},
	tPVPCh = {		
		["230"]="获取230品PVP装备",		
		["255"]="获取255品PVP装备",
		["310"]="获取310品PVP装备",
		["370"]="获取395品蓝色PVP装备",		
		["435"]="获取435品PVP装备",
		["475"]="获取475品PVP装备",
		["515"]="获取515品PVP装备",		 
	},	
	tYijiMenuCh = {
		["Button_28to90"]="我已满28级，我要升到90级",				--没做
		["Button_HorseBag"]="获得马匹，背包",
		["Button_FuZhu"]="获得辅助物品",
		["Button_FZ90"]="获得90级新增辅助物品",
		["Button_CLPF"]="获得淬炼配方",
		["Button_XYCL"]="获得稀有材料",
		["Button_ColorStone"]="获得五彩石",
		["Button_tMP"]="选择门派并升到90级",			--二级
		["Button_tPVE"]="获得门派相应PVE装备",			--二级
		["Button_tPVP"]="获得门派相应PVP装备",			--二级
		["Button_tFly"]="传送去其它地图",			--二级
		["Button_ZYHQ"]="加入浩气盟 ",
		["Button_ZYER"]="加入恶人谷 ",
		["Button_ZYZL"]="加入中立 ",		--没错这里就是有一个神奇欠揍的空格！！！    
		["Button_ClrBag"]="删除所有装备",
		["Button_MPDX"]="重归大侠号",
		["Button_Friend"]="增加好感度",
		["Button_MiJi"]="学习门派对应秘笈",
		["Button_XiuWei"]="获得修为",
		["Button_Money50"]="增加帮会资金到50万",
		["Button_SetGF"]="帮会工房建筑升级，帮主使用有效",
		["Button_SetDF"]="帮会丹房建筑升级，帮主使用有效",
		["Button_TMJG"]="获取唐门专用子弹",
	},	
	tBtnUnDXC={"Button_MiJi","Button_CLPF","Button_XYCL","Button_ZYHQ","Button_ZYER","Button_FuZhu","Button_FZ90","Button_ColorStone","Button_ClrBag","Button_ZYZL","Button_MPDX"},
	tBtnUnable = {"Button_PVPxxx",},
	tBtnFemaleUn = {"Button_MPSL","Button_MPCC"},
	tBtnHanziUn = {"Button_MPXX",},
	tBtnBoyUn = {"Button_MPTC","Button_MPCJ","Button_MPWD","Button_MPTM","Button_MPMJ","Button_MPCY","Button_MPWH","Button_MPCC",},	
	tMPBoyEn={"SL","XX","GB",},	--CC
	tMPFemaleEn={"TC","CY","WH","XX","CJ","WD","TM","MJ","GB",},	--CC
	tMPHanziEn={"TC","CY","WH","SL","CJ","WD","TM","MJ","GB","CC"},
}
JTZS.tErJiTable = {  
	["Button_Fly"]={JTZS.tYijiMenuCh["Button_tFly"], JTZS.tFlyChNew,},	--"传送去其它地图"
	["Button_MP"]={JTZS.tYijiMenuCh["Button_tMP"], JTZS.tMPCh,}, 	--"选择门派并升到90级",
	["Button_PVE"]={JTZS.tYijiMenuCh["Button_tPVE"],JTZS.tPVECh,}, 	-- "获得门派相应PVE装备"
	["Button_PVP"]={JTZS.tYijiMenuCh["Button_tPVP"], JTZS.tPVPCh,},	--"获得门派相应PVP装备"
}
JTZS.tRoleBtn = {[2]= JTZS.tBtnFemaleUn,[6]= JTZS.tBtnFemaleUn,[1]= JTZS.tBtnHanziUn,[5]= JTZS.tBtnBoyUn,}
JTZS.tMPEn = {[2]= JTZS.tMPFemaleEn,[6]= JTZS.tMPFemaleEn,[1]= JTZS.tMPHanziEn,[5]= JTZS.tMPBoyEn,}

JTZS.bFrameOpened = false							-- 控制窗口显示


 
 function JTZS.OnMouseEnter()		
	local szName = this:GetName()
	local szType = this:GetType()
	if szType == "WndFrame" and szName =="JTZS" then
		JTZS.openJT()
	end
	if szType == "WndButton" and szName ~="Button_Close" then

		if not this:IsEnabled() then
			local szSce=GetClientPlayer().GetScene().szDisplayName
			if szSce~="稻香村"	and szName~="Button_HorseBag" and  szName~="Button_XiuWei"  and szName~="Button_Friend" and  szName~="Button_TMJG"  and  szName~="Button_Money50"  and not string.find(szName,"Button_Set")  and not string.find(szName,"Button_Fly") then JTZS.ShowTip("该功能只能在稻香村使用") return end			
			if szName=="Button_SetGF" or szName=="Button_SetDF" then 
				if GetTongClient().dwMaster ~= GetClientPlayer().dwID then JTZS.ShowTip("仅帮主使用有效") else  JTZS.ShowTip("需回本帮帮会领地") end
				return 
			end
			for i = 1, #JTZS.tBtnUnable do
				if szName==JTZS.tBtnUnable[i] then JTZS.ShowTip("暂未开放") return end
			end
			local player=GetClientPlayer()
			tBtnUn2=JTZS.tRoleBtn[player.nRoleType]
			for i = 1, #tBtnUn2 do
				if szName==tBtnUn2[i] then 
					if player.nRoleType==5 and szName=="Button_MPCY" or szName=="Button_MPWH" then 
						JTZS.ShowTip("暂不可通过九天入该门派\n请少侠亲至该门派掌门处") 
					else
						JTZS.ShowTip("该门派暂时不收"..JTZS.tRoleType[player.nRoleType]) 
					end
				return 
				end
			end	
			if string.find(szName,"Button_MP") then	JTZS.ShowTip("请先重归大侠号")   return	end  	
			if string.find(szName,"Button_PVE") then JTZS.ShowTip("请先入门派")   return		end  	
			if string.find(szName,"Button_PVP") then JTZS.ShowTip("请先入门派和阵营")   return	end	 	
		end
		
		yjFlag=0
		for szBtnName,_ in pairs(JTZS.tYijiMenuCh) do 	
			if szName == szBtnName then 
				szFirCon = JTZS.tYijiMenuCh[szBtnName]		
			str=szFirCon
				JTZS.ShowTip(str,35)	
				if szName == "Button_ClrBag" then str="按住Ctrl，清空背包。" JTZS.ShowTip(str,163)
				elseif szName == "Button_ZYZL" then str="按住Ctrl，回归中立。"  JTZS.ShowTip(str,163)
				end
			
				yjFlag=1
				break
			end
		end
 
		if yjFlag==0 then 
			for szBtnGrp,_ in pairs(JTZS.tErJiTable) do 
				if string.find(szName,szBtnGrp) then		
					szFirCon = JTZS.tErJiTable[szBtnGrp][1]	
					selected=JTZS.YJMenu(szFirCon) 				
					local t = JTZS.tErJiTable[szBtnGrp][2]
					local x1,y1=string.find(szName,szBtnGrp)  
					szEJName = string.sub(szName,y1+1)
					szEJCon = t[szEJName]	 
					if selected ~= szFirCon  then 
						JTZS.ShowTip("移动太快，需点击两次\n若九天未打开，需重新移动鼠标")
					else
						JTZS.ShowTip(szEJCon,35)	
					end
					
					break
				end
			end	
		end
		
	end
end


function JTZS.ShowTip(str,fontscheme)	
	local nX, nY = this:GetAbsPos()
	local nW, nH = this:GetSize()
	fontscheme=fontscheme or 101 	
	str=GetFormatText(str, fontscheme) 
	OutputTip(str, 400, {nX, nY, nW, nH})
end
 

function JTZS.OnMouseLeave()
	local szName = this:GetName()
	local szType = this:GetType()
	HideTip()
	if (szType == "WndButton" and szName ~="Button_Close") then		
		Station.Lookup("Normal/DialoguePanel"):Hide() 	
	end
end


function JTZS.openJT()
	player=GetClientPlayer()
	if player.bOnHorse then	OutputMessage("MSG_ANNOUNCE_RED","骑乘状态不能使用【九天・逍遥】")  return end
	local dwBox, dwX=GetItemPosByItemTypeIndex(JTZS.JTTabType,JTZS.JTIndex)		
	if not dwBox then OutputMessage("MSG_ANNOUNCE_RED","背包中没有【九天・逍遥】，扔在仓库了吗？")	end
	OnUseItem(dwBox, dwX, GetUIItemBox(dwBox, dwX, true))  
end

 function JTZS.YJMenu(szContext)
     local fr=Station.Lookup("Normal/DialoguePanel")  
     if fr:IsVisible() then
        local nType,nID,nIdx,aInfo=fr.dwTargetType, fr.dwTargetId, fr.dwIndex,fr.aInfo
        if aInfo then  
			for i=1,#aInfo,1 do    
				if aInfo[i].name == "$" and aInfo[i].context == szContext then    
					nFirId=aInfo[i].attribute.id
					GetClientPlayer().WindowSelect(nIdx,nFirId)	
					return aInfo[i].context
				end
			end
		end
    end
end
 
function JTZS.EJMenu(szFirCon,szSecCon) 			
    local fr=Station.Lookup("Normal/DialoguePanel")  
    if fr:IsVisible() then
        local nType,nID,nIdx,aInfo=fr.dwTargetType, fr.dwTargetId, fr.dwIndex,fr.aInfo
        if aInfo then
			for i=1,#aInfo,1 do 		
				if aInfo[i].name == "$" and aInfo[i].context==szFirCon then  
					JTZS.YJMenu(szFirCon)  
					JTZS.ShowTip(szSecCon,35)  
					return   
				end
			end	 
			selected=JTZS.YJMenu(szSecCon)  	OutputMessage("MSG_ANNOUNCE_YELLOW",selected.."\n")    
		end
	end
end

	
function JTZS.OnLButtonClick()
	local szName = this:GetName()
	local frame = Station.Lookup("Topmost/JTZS")
	if szName == "Button_Close" then
		if not frame then	return	end
		frame:Hide()
		JTZS.bFrameOpened=false		
	end
	yjFlag = 0								
	if szName == "Button_ClrBag" then		
		ClrBagCon=JTZS.tYijiMenuCh[szName]  
		if IsCtrlKeyDown() then  --[[ selected=JTZS.YJMenu(ClrBagID) ]]  selected=JTZS.YJMenu(ClrBagCon)  OutputMessage("MSG_ANNOUNCE_YELLOW",selected.."\n")	--不是长久之计，顺移2    31+2
		else
			_JT.Alert("若确认清空背包，请按住Ctrl，同时按下【清空背包】按钮。", function() end, "Yes")   
		end
	elseif szName == "Button_ZYZL" then
		ZYZLCon=JTZS.tYijiMenuCh[szName]
		if IsCtrlKeyDown() then --[[  selected=JTZS.YJMenu(ZYZLID) ]] selected=JTZS.YJMenu(ZYZLCon)  return 
		else
			_JT.Alert("若确认回归中立，请按住Ctrl，同时按下【中 立】按钮。", function() end, "Yes")
		end
	else	
		for szBtnName,_ in pairs(JTZS.tYijiMenuCh) do 
			if szName == szBtnName then 
				szFirCon = JTZS.tYijiMenuCh[szBtnName]
				selected=JTZS.YJMenu(szFirCon)
				OutputMessage("MSG_ANNOUNCE_YELLOW",selected.."\n")
				yjFlag=1
				break
			end
		end
	end
 
	if yjFlag==0 then 	
		for szBtnGrp,_ in pairs(JTZS.tErJiTable) do 
			if string.find(szName,szBtnGrp) then	
				szFirCon = JTZS.tErJiTable[szBtnGrp][1]	
				t = JTZS.tErJiTable[szBtnGrp][2]
				local x1,y1=string.find(szName,szBtnGrp)  
				szEJName = string.sub(szName,y1+1)
				szSecCon = t[szEJName]	 
				JTZS.EJMenu(szFirCon,szSecCon) 
				break
			end
		end
	end
 end
	
 function JTZS.BtnUnable(szName)
	local f=Station.Lookup("Topmost/JTZS")
	local btn=f:Lookup(szName)
	btn:Enable(false)
 end
 
 function JTZS.BtnEnable(szName)
	local f=Station.Lookup("Topmost/JTZS")
	local btn=f:Lookup(szName)
	btn:Enable(1)
 end
 
 
function JTZS.OnFrameBreathe()
if GetLogicFrameCount() % 8 == 0 then
	local szSce=GetClientPlayer().GetScene().szDisplayName
	local frame = Station.Lookup("Topmost/JTZS")
	if frame then  	
		if szSce~="帮会领地" or GetTongClient().dwMaster ~= GetClientPlayer().dwID then 
			JTZS.BtnUnable("Button_SetGF")	JTZS.BtnUnable("Button_SetDF")  
		else
			JTZS.BtnEnable("Button_SetGF")	JTZS.BtnEnable("Button_SetDF")  
		end	
		if szSce~="稻香村"	then 			
			for i = 1, #JTZS.tBtnUnDXC	do	JTZS.BtnUnable(JTZS.tBtnUnDXC[i])	end 
			for szName,_ in pairs(JTZS.tMPCh)	do	JTZS.BtnUnable("Button_MP"..szName)	end 	
			for szName,_ in pairs(JTZS.tPVECh)  do	JTZS.BtnUnable("Button_PVE"..szName)	end 	
			for szName,_ in pairs(JTZS.tPVPCh)  do	JTZS.BtnUnable("Button_PVP"..szName)	end 
		else	 
			for i = 1, #JTZS.tBtnUnDXC	do	JTZS.BtnEnable(JTZS.tBtnUnDXC[i])	end
			local t=JTZS.tMPEn[GetClientPlayer().nRoleType]
			for i = 1,#t do	JTZS.BtnEnable("Button_MP"..t[i])	end	
			for szName,_ in pairs(JTZS.tPVECh)  do	JTZS.BtnEnable("Button_PVE"..szName)	end	
			for szName,_ in pairs(JTZS.tPVPCh)  do	JTZS.BtnEnable("Button_PVP"..szName)	end
			
			if GetClientPlayer().dwForceID~=0	then 	--Output("非大侠：禁门派 有PVE")
				for szMP,_ in pairs(JTZS.tMPCh)		do	JTZS.BtnUnable("Button_MP"..szMP)	end	
				for szPVE,_ in pairs(JTZS.tPVECh)	do	JTZS.BtnEnable("Button_PVE"..szPVE)	end			
			else 	
				local t=JTZS.tMPEn[GetClientPlayer().nRoleType]
				for i = 1,#t do	JTZS.BtnEnable("Button_MP"..t[i])	end
				for szPVE,_ in pairs(JTZS.tPVECh)	do	JTZS.BtnUnable("Button_PVE"..szPVE)	end
				for szPVP,_ in pairs(JTZS.tPVPCh)	do	JTZS.BtnUnable("Button_PVP"..szPVP)	end
			end	
			if  GetClientPlayer().nCamp==0	then	--Output("中立 无pvp")
				for szPVP,_ in pairs(JTZS.tPVPCh)	do	JTZS.BtnUnable("Button_PVP"..szPVP)	end
			elseif GetClientPlayer().dwForceID~=0 then 	--Output("阵营非大侠 有pvp")
				for szPVP,_ in pairs(JTZS.tPVPCh)	do	JTZS.BtnEnable("Button_PVP"..szPVP)	end
			end
			
		end	
	end 
end
end

  
function JTZS._OpenWindow()
	local frame = Station.Lookup("Topmost/JTZS")
	if frame then
		if frame:IsVisible() then
			frame:Hide() JTZS.bFrameOpened = false
		else
			frame:Show() JTZS.bFrameOpened = true
		end
	else
		frame = Wnd.OpenWindow("Interface\\TF\\JTXYZS\\JTZS.ini","JTZS")
		frame:Show() JTZS.bFrameOpened = true
		for i = 1, #JTZS.tBtnUnable do						
			JTZS.BtnUnable(JTZS.tBtnUnable[i])
		end
		local player=GetClientPlayer()
		tBtnUn2=JTZS.tRoleBtn[player.nRoleType]
		for i = 1, #tBtnUn2 do
			JTZS.BtnUnable(tBtnUn2[i])
		end
	end
end
 
 JTZS.OnFrameKeyDown = function()
	if GetKeyName(Station.GetMessageKey()) == "Esc" then
		JTZS._OpenWindow()
		return 1
	end
	return 0
end
 
 Player_AppendAddonMenu({ function()
	return {{
		szOption ="九天逍遥助手面板", bCheck = true,
		bChecked = JTZS.bFrameOpened,
		fnAction = JTZS._OpenWindow
	}}
end })
 
 TraceButton_AppendAddonMenu({ function()
	return {{
		szOption ="九天逍遥助手面板", bCheck = true,
		bChecked = JTZS.bFrameOpened,
		fnAction = JTZS._OpenWindow
	}}
end })



function  JTZS.RegAddonModInfo()
	local tDataJTZS={
		szName = "JTXYZS",										
		szTitle = "九天逍遥",										
		dwIcon = 637,												
		szClass = "TOOL",	
		tWidget={
			{
				tag = "JTZS_OpenWnd", type = "WndButton",					 
				w = 100, h = 29, text = "打开界面",					 
				anchor = "TOPLEFT", x = 0, y = 0,				 
				callback = function()							 
					JTZS._OpenWindow()
				end
			},
			{	tag = "JTZS_ShuoMing", type = "WndTextBox", 				 
				w = 480, h = 28, text = "【功能说明】快速选择[九天・逍遥]功能，受够滚动条有没有！",					 
				anchor = "TOPLEFT", x = 0, y = 30,				 
			},{	tag = "JTZS_zhuyi", type = "WndTextBox", 				 
				w = 480, h = 28, text = "【使用注意】蓝字区域为九天二级菜单，可能需按两次生效。",					 
				anchor = "TOPLEFT", x = 0, y = 60,				 
			},
			{	tag = "JTZS_Author", type = "WndTextBox", 				 
				w = 160, h = 28, text = "By 微雨凭阑", fontcolor={0,255,255},					 
				anchor = "TOPLEFT", x = 300, y = 330, 				 
			},
		},
	}

	CUIRegAddonModInfo(tDataJTZS)	
end

RegisterEvent("CUSTOM_DATA_LOADED", function()						 
	if arg0 == "Role" then
		JTZS.RegAddonModInfo()
	end
end)
